# スマスロ モンキーターンV 設定判別ツール - プロジェクト完全概要

## 📋 プロジェクト概要

スマホ最適化された、スマスロ「モンキーターンV」の設定判別を行うWebアプリケーション。  
プレイヤーが入力した**総回転数**と**5枚役回数**をもとに、**ベイズ推定**を用いて現在打っている台の設定（1, 2, 4, 5, 6）の期待度を計算・表示します。

---

## 🎯 主要機能

### 1. **入力機能**
- **総回転数（G数）**: 現在の回転数を入力
  - クイック加算ボタン: `+50`, `+100`, `+500`, `+1000`
  - リセットボタンで即座にクリア
- **5枚役回数**: 小役のカウント数を入力
  - クイック加算ボタン: `+1`, `+5`, `+10`, `+20`
  - リセットボタンで即座にクリア

### 2. **設定判別計算**
#### ベイズ推定による確率計算
- **使用確率データ**（5枚役の出現確率）:
  - 設定1: 1/38.15
  - 設定2: 1/36.86
  - 設定4: 1/30.27
  - 設定5: 1/24.51
  - 設定6: 1/22.53
- **二項分布の尤度計算**を行い、各設定の事後確率を算出
- **正規化**により確率分布を生成

#### 判定指標
- **456期待度**: 設定4以上である確率（設定4, 5, 6の合算）
- **56期待度**: 設定5以上である確率（設定5, 6の合算）
- **現在の確率**: 実測の5枚役確率（分母形式: 1/XX.X）

### 3. **信頼度評価システム（星評価）**
#### ★1〜★5段階の評価
- **スコアリングアルゴリズム**:
  1. 目標確率（456 or 56）が閾値を超えているか
  2. 対立確率との差分が十分あるか
  3. 合計スコアに応じて★1〜★5を決定

#### 動的コメント生成
サンプル数（総回転数）と星評価に基づいて、プレイヤーの心理に寄り添ったコメントを表示:
- **序盤（<1000G）**: 「最高のロケットスタート！」「まだ見切るには早すぎます」など
- **中盤（1000-3000G）**: 「高設定の挙動で安定」「どっちつかずの展開」など
- **終盤（3000G~）**: 「閉店までブン回し確定レベル」「無理せず切り上げるのが賢明」など

### 4. **詳細データ表示**
- **設定別期待度の視覚化**: 各設定（1, 2, 4, 5, 6）ごとの確率をプログレスバーで表示
  - カラーコード:
    - 設定1: グレー
    - 設定2: ダークグレー
    - 設定4: イエロー
    - 設定5: オレンジ
    - 設定6: レッドグラデーション

### 5. **シェア機能**
- **コピー用テキスト生成**: 計算結果を整形されたテキスト形式で出力
  - 総回転数、5枚役確率、456/56期待度、星評価、コメントを含む
  - SNSやLINEで簡単にシェア可能

---

## 🏗️ 技術仕様・アーキテクチャ

### 使用技術スタック
- **フレームワーク**: Streamlit（Python Webアプリケーション）
- **言語**: Python 3.x
- **数学ライブラリ**: `math`（対数ガンマ関数、確率計算）
- **UI**: カスタムCSS（モバイル最適化、ダークモード）

### ファイル構成
```
codex_project/
├── main.py                   # アプリケーションのエントリーポイント
├── requirements.txt          # 依存パッケージ
├── src/
│   ├── constants.py          # 設定データ・閾値定義
│   ├── logic.py              # ベイズ推定・評価ロジック
│   ├── styles.py             # カスタムCSS（スマホUI最適化）
│   └── components.py         # UIコンポーネント（カード、星、ボタン等）
├── koyaku_counter_component/ # Reactカスタムコンポーネント（未使用/削除候補）
└── README.md                 # 簡易説明
```

---

## 🧮 核心アルゴリズム詳細

### 1. 二項分布の尤度計算
```python
def calculate_likelihood(num_spins: int, num_hits: int, p: float) -> float:
    """
    P(K=k | N=n, p) の尤度を計算
    - num_spins: 総回転数 (N)
    - num_hits: 5枚役回数 (K)
    - p: 設定ごとの確率
    - 対数を使って数値的に安定した計算を実現
    """
    log_nCk = math.lgamma(num_spins + 1) - math.lgamma(num_hits + 1) - math.lgamma(num_spins - num_hits + 1)
    log_likelihood = log_nCk + num_hits * math.log(p) + (num_spins - num_hits) * math.log(1.0 - p)
    return math.exp(log_likelihood)
```

### 2. ベイズ更新
```python
def compute_posteriors(num_spins: int, num_hits: int, priors: Dict[str, float]) -> Dict[str, float]:
    """
    事前確率 × 尤度 = 事後確率
    - priors: 各設定の事前確率（初期は均等）
    - posteriors: 観測データを反映した事後確率
    """
    for 各設定:
        尤度 = calculate_likelihood(num_spins, num_hits, 設定の確率)
        事後確率の分子 = 尤度 × 事前確率
    
    正規化して事後確率を返す
```

### 3. 信頼度評価
```python
def evaluate_goal(goal_code: str, goal_prob: float, alt_prob: float, sample_n: int, ci_range_pct: float):
    """
    - goal_code: "456" or "56"
    - goal_prob: 目標確率（456期待度 or 56期待度）
    - alt_prob: 対立確率（12期待度 or 124期待度）
    - sample_n: サンプル数（総回転数）
    
    スコアリング:
    1. goal_prob が閾値（high/mid/low）と比較
    2. (goal_prob - alt_prob) の差分が閾値と比較
    3. 合計スコアで星1〜5を決定
    4. サンプル数に応じて動的コメント生成
    """
```

---

## 📊 設定判別の閾値設定

### 456期待度
- **高信頼（★4-5）**: goal_prob ≥ 75% または diff ≥ 15%
- **中信頼（★3）**: goal_prob ≥ 65% または diff ≥ 7%
- **低信頼（★1-2）**: goal_prob < 48%
- **最小サンプル警告**: 120G未満
- **推奨サンプル**: 220G以上

### 56期待度
- **高信頼（★4-5）**: goal_prob ≥ 58% または diff ≥ 8%
- **中信頼（★3）**: goal_prob ≥ 50% または diff ≥ 4%
- **低信頼（★1-2）**: goal_prob < 35%
- **最小サンプル警告**: 160G未満
- **推奨サンプル**: 240G以上

---

## 🎨 UI/UXの特徴（スマホ最適化）

### デザインコンセプト
- **ダークモード**: 背景 `#0f0f0f`、カード `#1a1a1a`
- **タイポグラフィ**: `-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto`
- **カラースキーム**:
  - アクセントブルー: `#3a9bdc`
  - ゴールドスター: `#ffd700`（ドロップシャドウ付き）
  - グラデーション: 設定6はレッドグラデーション

### レスポンシブ要素
- **最大幅**: 600px（スマホ画面に最適）
- **ボタンサイズ**: 高さ2.5rem、タップしやすい大きさ
- **インタラクション**: ホバー/アクティブ時にボタンが拡大縮小
- **情報カード**: 視覚的に分かりやすいグラデーションとボーダー

### コンポーネント設計
1. **モバイルヘッダー**: 中央揃えの絵文字付きタイトル
2. **結果カード**: タイトル、値、星評価、コメントを1つのカードに凝縮
3. **プログレスバー**: 設定別確率を色分けされた横棒グラフで表現
4. **クイック入力**: 4つのボタンで素早く数値を加算

---

## 🔄 実行フロー

```
1. ユーザーが総回転数と5枚役回数を入力
   ↓
2. ベイズ推定で各設定の事後確率を計算
   ↓
3. 456期待度、56期待度を算出
   ↓
4. 信頼度評価（星とコメント生成）
   ↓
5. UI表示:
   - 456期待度カード（星評価付き）
   - 56期待度カード（星評価付き）
   - 現在の確率カード
   - 設定別詳細データ（折りたたみ可能）
   - シェア用テキスト（折りたたみ可能）
```

---

## 🚀 実装時の重要ポイント

### 数値計算の安定性
- **対数計算**: 二項分布の計算で直接の階乗を避け、`math.lgamma`を使用
- **ゼロ除算対策**: 確率が0の場合の処理を厳密に実装

### ユーザー体験
- **セッション状態管理**: Streamlitの`st.session_state`で入力値を保持
- **即座のフィードバック**: ボタンクリック後に`st.rerun()`で瞬時に再描画
- **HTMLインジェクション対策**: `unsafe_allow_html=True`使用時も安全な文字列処理

### パフォーマンス
- **軽量実装**: 外部APIなし、計算はすべてクライアントサイド（Pythonバックエンド）
- **CSSインライン化**: `styles.py`で1ファイルにまとめて高速ロード

---

## 📱 ターゲットユーザー

- **パチスロプレイヤー**: モンキーターンVを打っている最中に設定を判別したい人
- **スマホユーザー**: ホールで立ちながら、または座りながらサッと確認
- **データ重視型**: 勘ではなく数値的根拠で台の良し悪しを判断したい人

---

## 💡 機能拡張のアイデア（未実装）

1. **履歴保存機能**: 過去の判別結果をブラウザに保存
2. **グラフ表示**: 回転数ごとの期待度推移をチャート化
3. **他の小役対応**: ベル、リプレイなどの複合判別
4. **通知機能**: 一定の信頼度に達したらアラート
5. **PWA化**: オフラインでも使用可能なアプリ化

---

## 🔧 デプロイ方法

### ローカル実行
```bash
# 依存関係インストール
pip install -r requirements.txt

# アプリ起動
streamlit run main.py
```

### クラウドデプロイ（Streamlit Cloud推奨）
1. GitHubにリポジトリをプッシュ
2. Streamlit Cloudで新規アプリ作成
3. リポジトリと`main.py`を指定
4. 自動デプロイ完了

---

## 📝 コード品質・保守性

### モジュール分割の意図
- **`constants.py`**: マジックナンバーの排除、設定変更の容易性
- **`logic.py`**: ビジネスロジックとUIの分離、テスト容易性
- **`styles.py`**: デザイン変更の一元管理
- **`components.py`**: 再利用可能なUI部品

### 命名規則
- **関数**: 動詞で始まる（`calculate_`, `render_`, `evaluate_`）
- **変数**: 意味が明確（`num_spins`, `goal_prob`, `posteriors`）
- **型ヒント**: 全関数に引数と戻り値の型を明示

---

## 🎓 学んだ技術・概念

1. **ベイズ統計**: 事前確率と尤度から事後確率を求める
2. **二項分布**: 試行回数と成功確率から確率質量関数を計算
3. **StreamlitのState管理**: セッション状態でインタラクティブUIを実現
4. **モバイルファーストCSS**: スマホに最適化されたレスポンシブデザイン
5. **ユーザー心理**: サンプル数や状況に応じた動的メッセージング

---

## 📖 参考情報

### 機種情報
- **機種名**: スマスロ モンキーターンV
- **メーカー**: YAMASA（山佐）
- **解析サイト**: 各パチスロ攻略サイトの5枚役確率データを使用

### 数学的背景
- **ベイズの定理**: P(H|E) = P(E|H) * P(H) / P(E)
- **二項分布**: P(K=k|N=n,p) = nCk * p^k * (1-p)^(n-k)
- **対数ガンマ関数**: 大きな階乗の計算を安定化

---

## ⚠️ 注意事項

### 免責事項
- このツールは**参考情報**であり、100%の精度を保証するものではありません
- パチスロは確率の収束に時間がかかるため、少ないサンプル数での判断は注意が必要
- 設定判別はあくまで補助ツールとして使用し、最終判断は自己責任で行ってください

### 法的配慮
- ギャンブル依存症に配慮し、過度なプレイを推奨しない
- 20歳未満の使用を想定していない
- ホール規約に従って使用すること

---

## 📞 再構築時のチェックリスト

別環境で作り直す際は、以下を確認してください：

- [ ] Python 3.7以上の環境
- [ ] `requirements.txt`の依存関係をインストール
- [ ] `src/`ディレクトリ構造を再現
- [ ] 5枚役確率データ（`constants.py`）が最新か確認
- [ ] ベイズ推定のロジック（`logic.py`）を正確に移植
- [ ] モバイルCSS（`styles.py`）のブレイクポイント調整
- [ ] UIコンポーネント（`components.py`）の動作確認
- [ ] テストデータでの動作検証（例: 3000G、150回など）
- [ ] スマホ実機での表示確認

---

## 🏁 終わりに

このツールは、**データドリブンなパチスロ判別**と**優れたモバイルUX**を両立させた実用的なWebアプリケーションです。  
ベイズ推定という確率論的アプローチを採用することで、プレイヤーに客観的な判断材料を提供します。

再構築する際は、この概要ドキュメントを参照しながら、必要に応じて機能追加や改善を行ってください。

**Good Luck & Have Fun! 🎰✨**
